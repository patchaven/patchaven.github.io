<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>robertaæ¨¡å‹ä½ åœ¨å¹²å˜›</title>
    <link href="/2025/02/08/robertawhy/"/>
    <url>/2025/02/08/robertawhy/</url>
    
    <content type="html"><![CDATA[<h2 id="intro">intro</h2><blockquote><p>robertaæ¨¡å‹ä¸ºä½•è¿™æ ·</p></blockquote><h2 id="tldr">TL;DR</h2><p>å¦‚æœä½ åœ¨è¯•å›¾å‘huggingfaceçš„Robertaæ¨¡å‹é‡Œè¾“å…¥inputs_embedsæ—¶é‡åˆ°äº†IndexErrorçš„è¯ï¼š</p><ol type="1"><li>å¦‚æœIndexErroræ˜¯å’Œä½ç½®åµŒå…¥æœ‰å…³çš„é‚£è¿™ç¯‡å¯èƒ½æœ‰å…³ï¼›</li><li>æ¨¡å‹æºä»£ç é‡Œç”±inputs_embedsç”Ÿæˆposition_idsä¼šè€ƒè™‘padding_idx(pad_token_id)ï¼›</li><li>Robertaæ¨¡å‹çš„åŸå§‹é…ç½®RobertaConfigé‡Œpad_token_idä¸º1ï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·ä¸è¾“å…¥è‡ªå®šä¹‰position_idsï¼Œç”Ÿæˆçš„idæ˜¯ä»2å¼€å§‹çš„ã€‚è¯­æ–™é•¿åº¦å’Œæœ€é•¿é•¿åº¦ç›¸å·®ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œposition_idså¯èƒ½ä¼šå’Œposition_embeddingå†²çªï¼Œä»è€Œå¯¼è‡´IndexErrorï¼›</li><li>ä¸æ˜¯é‚£æ‹‰å€’</li></ol><h2 id="é—®é¢˜">é—®é¢˜</h2><p>æ™®éçš„nlpæ„å»ºæ¨¡å‹æµç¨‹ï¼ˆå¯èƒ½å§å› ä¸ºæˆ‘ä¸åšè‡ªç„¶è¯­è¨€ï¼‰ï¼ˆDNAéš¾é“ä¸æ˜¯ä¸€ç§çœŸæ­£çš„è‡ªç„¶è¯­è¨€â€¦â€¦ï¼Ÿï¼‰ï¼šå¾—åˆ°å¾…è®­ç»ƒçš„æ–‡æœ¬-- å¯¹æ–‡æœ¬åšäº›é¢„å¤„ç† -- é€‰æ‹©å¹¶è®­ç»ƒé€‚åˆçš„åˆ†è¯å™¨ --ç”¨åˆ†è¯å™¨å¯¹å¤„ç†å¥½çš„æ–‡æœ¬è¿›è¡Œåˆ†è¯ï¼Œå¾—åˆ°è¯ç´¢å¼• --ç»„ç»‡æˆå¯ä»¥æ‰¹é‡è¾“å…¥åˆ°æ¨¡å‹é‡Œçš„æ•°æ®ç»“æ„ï¼Œå¼€å§‹è®­ç»ƒã€‚ä½†æˆ‘ç°åœ¨çš„ç§‘å­¦é—®é¢˜å·²ç»è¿›åˆ°äº†éœ€è¦ç”¨å¥‡æŠ€æ·«å·§ï¼ˆæœ‰å¿…è¦è¿™ä¹ˆå½¢å®¹å—ï¼‰æ¥ç»•é“çš„èƒ¡åŒï¼Œä¸çŸ¥æ˜¯ç¦æ˜¯ç¥¸å•Šï¼æ‰€ä»¥ç°åœ¨æˆ‘æƒ³åšçš„æ˜¯ï¼šç»•è¿‡æŠ±æŠ±è„¸é‡Œå·²ç»å®ç°å¥½çš„æ¨¡å‹é‡Œå·²æœ‰embeddingå±‚ï¼Œè‡ªå·±å…ˆç»™ä¸€ä¸ªèµ·å§‹çš„åµŒå…¥ã€‚è™½ç„¶ä¸çŸ¥é“è¿™å¯¹æ­¤ç§‘å­¦é—®é¢˜åˆ°åº•å¢ç›Šå‡ ä½•ï¼Œä½†æŠ€æœ¯é—®é¢˜å·²å ‚å ‚è¢­æ¥ï¼</p><h3 id="å¤ç°é—®é¢˜">å¤ç°é—®é¢˜</h3><p>å¯¹åŸå§‹æ•°æ®æ“ä½œä¸€ç•ªåï¼Œå…ˆå–äº†ä¸€ä¸ªbatchçš„åµŒå…¥è¯•è¯•èƒ½ä¸èƒ½è·‘é€šï¼Œå…¶å½¢çŠ¶ä¸º<code>torch.Size([32, 512, 4])</code>ã€‚</p><p>æ ¹æ®robertaæ¨¡å‹è¯´æ˜é¡µé¢é‡Œé¢å¯¹inputs_embedsçš„è¯´æ˜ï¼š</p><blockquote><p>(<code>torch.FloatTensor</code> of shape<code>(batch_size, sequence_length, hidden_size)</code>,<em>optional</em> ) â€” Optionally, instead of passing<code>input_ids</code> you can choose to directly pass an embeddedrepresentation. This is useful if you want more control over how toconvert <code>input_ids</code> indices into associated vectors than themodelâ€™s internal embedding lookup matrix.</p></blockquote><p>æ¨¡å‹çš„å‚æ•°è®¾ç½®ï¼š</p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">roberta_config = RobertaConfig(<br>vocab_size=<span class="hljs-number">20</span>,  <span class="hljs-comment">#æ²¡æƒ³å¥½ï¼Œå…ˆå ä¸ªä½</span><br>hidden_size=<span class="hljs-number">256</span>,  <br>num_hidden_layers=<span class="hljs-number">12</span>,  <br>num_attention_heads=<span class="hljs-number">8</span>,  <br>intermediate_size=<span class="hljs-number">1024</span>,  <br>max_position_embeddings=<span class="hljs-number">512</span>,    )<br></code></pre></td></tr></table></figure></blockquote><p>æ—¢ç„¶è¾“å…¥çš„å¼ é‡æœ€åä¸€ä¸ªç»´åº¦è¦å’Œæ¨¡å‹çš„éšè—å±‚ç»´åº¦ç›¸åŒï¼Œé‚£ä¹ˆæˆ‘å°±ç”¨äº†ä¸€ä¸ªnn.linearæŠŠ4ç»´å‡åˆ°256ç»´ï¼Œå¾—åˆ°<code>torch.Size([32, 512, 256])</code>çš„å¼ é‡ã€‚</p><p>å°†è¿™ä¸ªå¼ é‡è¾“å…¥åˆ°robertaæ¨¡å‹åæŠ¥é”™ï¼ˆæˆªå–éƒ¨åˆ†æŠ¥é”™ä¿¡æ¯ï¼‰ï¼š</p><blockquote><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs routeros">---------------------------------------------------------------------------<br>IndexError                                Traceback (most recent call last)<br>Cell <span class="hljs-keyword">In</span>[21],line 1<br>----&gt; 1 out1 = roberta_lm_model(<span class="hljs-attribute">inputs_embeds</span>=out, <span class="hljs-attribute">output_hidden_states</span>=<span class="hljs-literal">True</span>,position_ids=position_ids)<br><br>File ~/path/<span class="hljs-keyword">to</span>/nn/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py:1204, <span class="hljs-keyword">in</span> RobertaForMaskedLM.forward(self, input_ids, attention_mask, token_type_ids, position_ids, head_mask, inputs_embeds, encoder_hidden_states, encoder_attention_mask, labels, output_attentions, output_hidden_states, return_dict)labels (torch.LongTensor of shape (batch_size, sequence_length), optional):<br>-&gt;  outputs =self.roberta(<br>input_ids,<br><span class="hljs-attribute">attention_mask</span>=attention_mask,<br><span class="hljs-attribute">token_type_ids</span>=token_type_ids,<br><span class="hljs-attribute">position_ids</span>=position_ids,<br><span class="hljs-attribute">head_mask</span>=head_mask,<br><span class="hljs-attribute">inputs_embeds</span>=inputs_embeds,<br><span class="hljs-attribute">encoder_hidden_states</span>=encoder_hidden_states,<br><span class="hljs-attribute">encoder_attention_mask</span>=encoder_attention_mask,<br><span class="hljs-attribute">output_attentions</span>=output_attentions,<br><span class="hljs-attribute">output_hidden_states</span>=output_hidden_states,<br><span class="hljs-attribute">return_dict</span>=return_dict,<br>)<br>sequence_output = outputs[0]<br>prediction_scores =self.lm_head(sequence_output)<br><br>File ~/path/<span class="hljs-keyword">to</span>/nn/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py:912, <span class="hljs-keyword">in</span> RobertaModel.forward(self, input_ids, attention_mask, token_type_ids, position_ids, head_mask, inputs_embeds, encoder_hidden_states, encoder_attention_mask, past_key_values, use_cache, output_attentions, output_hidden_states, return_dict)<br><span class="hljs-keyword">else</span>:<br>token_type_ids = torch.zeros(input_shape, <span class="hljs-attribute">dtype</span>=torch.long, <span class="hljs-attribute">device</span>=device)<br>--&gt; embedding_output =self.embeddings(<br><span class="hljs-attribute">input_ids</span>=input_ids,<br><span class="hljs-attribute">position_ids</span>=position_ids,<br><span class="hljs-attribute">token_type_ids</span>=token_type_ids,<br><span class="hljs-attribute">inputs_embeds</span>=inputs_embeds,<br><span class="hljs-attribute">past_key_values_length</span>=past_key_values_length,<br>)<br><span class="hljs-keyword">if</span> attention_mask isNone:<br>attention_mask = torch.ones((batch_size, seq_length + past_key_values_length), <span class="hljs-attribute">device</span>=device)<br><br>File ~/path/<span class="hljs-keyword">to</span>/nn/lib/python3.10/site-packages/transformers/models/roberta/modeling_roberta.py:127, <span class="hljs-keyword">in</span> RobertaEmbeddings.forward(self, input_ids, token_type_ids, position_ids, inputs_embeds, past_key_values_length)<br>embeddings = inputs_embeds + token_type_embeddings<br><span class="hljs-keyword">if</span> self.position_embedding_type ==<span class="hljs-string">&quot;absolute&quot;</span>:<br>--&gt; position_embeddings =self.position_embeddings(position_ids)<br>embeddings += position_embeddings<br>embeddings =self.LayerNorm(embeddings)<br><br>File ~/path/<span class="hljs-keyword">to</span>/nn/lib/python3.10/site-packages/torch/nn/functional.py:2551, <span class="hljs-keyword">in</span> embedding(input, weight, padding_idx, max_norm, norm_type, scale_grad_by_freq, sparse)<br><span class="hljs-comment"># Note [embedding_renorm set_grad_enabled]</span><br><span class="hljs-comment"># <span class="hljs-doctag">XXX:</span> equivalent to</span><br><span class="hljs-comment"># with torch.no_grad():</span><br><span class="hljs-comment">#   torch.embedding_renorm_</span><br><span class="hljs-comment"># remove once script supports set_grad_enabled</span><br>no_grad_embedding_renorm(weight, input, max_norm, norm_type)<br>-&gt;  return torch.embedding(weight, input, padding_idx, scale_grad_by_freq, sparse)IndexError: index out of range <span class="hljs-keyword">in</span> self<br></code></pre></td></tr></table></figure></blockquote><h3 id="æŠ¥é”™äº†æ€ä¹ˆåŠ">æŠ¥é”™äº†æ€ä¹ˆåŠï¼</h3><p>å¥³å­©å…¶å®ä¸æ‡‚æ€ä¹ˆçœ‹æŠ¥é”™ä¿¡æ¯ã€æ‰€ä»¥é¦–å…ˆæŠŠæ‰€æœ‰æŠ¥é”™ï¼ˆåŒ…æ‹¬æ ‡å‡†åº“çš„ï¼‰å…¨å–‚ç»™dså¹¶ç”¨æœ€ç®€å•çš„é—®å¥ã€æ€ä¹ˆè§£å†³ã€‘é—®äº†ã€‚ä¹çš„æ˜¯dsè™½ç„¶çŸ¥é“è¿™æ˜¯ä¸ªç´¢å¼•è¶…å‡ºèŒƒå›´é—®é¢˜ï¼Œä½†ä¸€ç›´åœ¨æ€ç»´é“¾é‡Œåå¤ã€ä¸è¿‡åœ¨è¿™é‡Œè¾“å…¥çš„åºåˆ—é•¿åº¦æ˜¯512ï¼Œæ¨¡å‹è®¾ç½®æ˜¯512ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚ã€‘ï¼ˆåˆšè§£å†³æ­¤é—®é¢˜åå¾—æ„å¿˜å½¢å°†å¯¹è¯è®°å½•åˆ æ‰äº†å•Šå•Šå•Šå•Šè®©æˆ‘è¯•è¯•èƒ½å¦é‡ç°ï¼‰ï¼Œåªèƒ½æ·¡æ·¡åœ°åˆæ¢äº†å‡ ä¸ªå¹³å°æ¢äº†å‡ ç§é—®é—®é¢˜æ–¹æ³•ï¼ˆå…¶å®åº”è¯¥ä¿ç•™å¯¹è¯ä¸‹æ¥å¤ç›˜ä¸€ä¸‹åº”è¯¥æ€ä¹ˆæœ‰æ•ˆè°ƒæ•™aiçš„ä½†å¥³å­©å…¨åˆ æ‰äº†ï¼Œå¥³å­©ä½ è¿™æ ·æ˜¯æ°¸è¿œæ— æ³•èµšåˆ°å–è¯¾çš„é’±çš„ï¼‰ã€‚</p><p>é—®ç€é—®ç€è™½ç„¶æ²¡èƒ½å¾—åˆ°ç›´æ¥çš„è§£å†³æ–¹æ³•ï¼Œä½†ä»ç­”æ¡ˆé‡Œè¿˜æ˜¯å¯ä»¥çŸ¥é“ï¼šæ˜¯position_idsè¿™ä¸ªå˜é‡é‡ŒåŒ…å«äº†è¶…è¿‡æ¨¡å‹å…è®¸çš„ä½ç½®ç´¢å¼•ï¼Œä»è€Œå¯¼è‡´äº†ç´¢å¼•è¶…å‡ºæŠ¥é”™ï¼Œå¯ä»¥ç€é‡çœ‹ä¸€ä¸‹è¿™å¥ä»£ç </p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">--&gt; <span class="hljs-number">127</span> position_embeddings =<span class="hljs-variable language_">self</span>.position_embeddings(position_ids)<br></code></pre></td></tr></table></figure></blockquote><p>æˆ‘ï¼šä¹‹å‰ç”¨input_idsçš„æ—¶å€™ä¹Ÿæ²¡é‡åˆ°è¿™ä¸ªé—®é¢˜å•Šâ€¦â€¦ä½†ä¹‹å‰çš„åºåˆ—é•¿åº¦ç”±äºåˆ†è¯å™¨åˆ†è¯æ“ä½œæ‰€ä»¥æ¯å¥çš„é•¿åº¦ä¸ä¸€è€Œä¸”éƒ½æ²¡æœ‰åˆ°512çš„ï¼Œæ‰€ä»¥æ²¡å‡ºç°è¿™ä¸ªé—®é¢˜ã€‚ç°åœ¨æ˜¯æ¯æ¡åºåˆ—çš„é•¿åº¦éƒ½ä¸º512ï¼Œä½†æ¨¡å‹çš„æœ€å¤§ä½ç½®åµŒå…¥å‚æ•°è®¾ç½®çš„ä¹Ÿæ˜¯512å•Šä¹‹å‰ä¹Ÿæ²¡çœ‹åˆ°å“ªé‡Œè¯´è¿™ä¸ªå‚æ•°æœ‰ä»€ä¹ˆè®¾ç½®çš„è¦æ±‚ã€‚å‡ºäºæ‡’ã€ç•éš¾æƒ…ç»ªå’Œå¯¹æºä»£ç çš„ä¿¡ä»»ï¼Œå¥³å­©ä¸€å¼€å§‹å¹¶æ²¡æœ‰æƒ³ç€çœ‹çœ‹æºä»£ç åœ¨å¹²å˜›ï¼Œè€Œæ˜¯å°è¯•æ”¹äº†ä¸€ä¸‹max_position_embeddingsè¿™ä¸ªå‚æ•°ã€‚ç»“æœä¸ºï¼šæ”¹æˆ513-- ç»§ç»­æŠ¥é”™ï¼Œæ”¹æˆ514 -- ä¸æŠ¥é”™äº†ã€‚</p><p>ï¼Ÿ</p><p>åˆ°è¿™é‡Œå·²ç»å¼€å§‹æ„Ÿè§‰ï¼šä¸ä¼šæ˜¯ç´¢å¼•èµ·å§‹å’Œå·¦é—­å³å¼€å§â€¦â€¦ç„¶åè¢«å«å»1on1äº†ï¼ˆå¥³å­©è¿™æ˜¯ä½ çš„ç¬”è®°è¿˜æ˜¯æ—¥è®°ï¼Ÿï¼‰ï¼Œè°ˆè¯ç»“æŸåæ‘†çƒ‚ä¸€ä¸‹åˆç›´è‡³æ™šä¸Šæ‰å¼€å§‹çœŸæ­£å¹²æ´»ï¼Œç»ˆäºå›å»çœ‹æºä»£ç è¿™éƒ¨åˆ†åˆ°åº•åœ¨å¹²å˜›ï¼Œå‘ç°ï¼š</p><p>åœ¨<ahref="https://github.com/huggingface/transformers/blob/v4.48.2/src/transformers/models/roberta/modeling_roberta.py#L127">modeling_roberta.py</a>é‡Œæ‰¾æŠ¥é”™çš„ç¬¬127è¡Œä»£ç ä»¥åŠç›¸å…³å‡½æ•°</p><blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-variable language_">self</span>.padding_idx = config.pad_token_id<br><span class="hljs-variable language_">self</span>.position_embeddings = nn.Embedding(config.max_position_embeddings, config.hidden_size, padding_idx=<span class="hljs-variable language_">self</span>.padding_idx)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params"></span><br><span class="hljs-params">        self, input_ids=<span class="hljs-literal">None</span>, token_type_ids=<span class="hljs-literal">None</span>, position_ids=<span class="hljs-literal">None</span>, inputs_embeds=<span class="hljs-literal">None</span>, past_key_values_length=<span class="hljs-number">0</span></span><br><span class="hljs-params">    </span>):<br>        <span class="hljs-keyword">if</span> position_ids <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">if</span> input_ids <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:<br>                <span class="hljs-comment"># Create the position ids from the input token ids. Any padded tokens remain padded.</span><br>                position_ids = create_position_ids_from_input_ids(input_ids, <span class="hljs-variable language_">self</span>.padding_idx, past_key_values_length)<br>            <span class="hljs-keyword">else</span>:<br>                position_ids = <span class="hljs-variable language_">self</span>.create_position_ids_from_inputs_embeds(inputs_embeds)<br><span class="hljs-keyword">if</span> <span class="hljs-variable language_">self</span>.position_embedding_type == <span class="hljs-string">&quot;absolute&quot;</span>:<br>--&gt; <span class="hljs-number">127</span>     position_embeddings = <span class="hljs-variable language_">self</span>.position_embeddings(position_ids)<br>            embeddings += position_embeddings<br><br>  <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_position_ids_from_inputs_embeds</span>(<span class="hljs-params">self, inputs_embeds</span>):<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">We are provided embeddings directly. We cannot infer which are padded so just generate sequential position ids.</span><br><span class="hljs-string">Args:</span><br><span class="hljs-string">     inputs_embeds: torch.Tensor</span><br><span class="hljs-string"></span><br><span class="hljs-string">Returns: torch.Tensor</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        input_shape = inputs_embeds.size()[:-<span class="hljs-number">1</span>]<br>        sequence_length = input_shape[<span class="hljs-number">1</span>]<br><br>        position_ids = torch.arange(<br>            <span class="hljs-variable language_">self</span>.padding_idx + <span class="hljs-number">1</span>, sequence_length + <span class="hljs-variable language_">self</span>.padding_idx + <span class="hljs-number">1</span>, dtype=torch.long, device=inputs_embeds.device<br>        )<br>        <span class="hljs-keyword">return</span> position_ids.unsqueeze(<span class="hljs-number">0</span>).expand(input_shape)<br></code></pre></td></tr></table></figure></blockquote><p>æ—¢ç„¶ç¬¬127ä»£ç å¯¼è‡´äº†æŠ¥é”™ï¼Œé‚£é‡Œé¢çš„position_idsæ˜¯å¦ä¹Ÿæœ‰é—®é¢˜ï¼Ÿä¸€å¼€å§‹æˆ‘æ²¡æœ‰è¾“å…¥position_idsï¼Œæ‰€ä»¥RobertaEmbeddingç±»é‡Œçš„å‡½æ•°create_position_ids_from_inputs_embedsç”Ÿæˆäº†ä¸€ä¸ªã€‚åé¢aiåˆå»ºè®®æˆ‘è‡ªå·±åˆ›å»ºä¸€ä¸ªposition_ids(ä»£ç å¦‚ä¸‹)ï¼Œç„¶åå°±æ²¡æœ‰æŠ¥é”™äº†â€¦â€¦æ€ä¹ˆå›äº‹å•Šä½ ä»¬è‡ªå·±è¿˜å’Œè‡ªå·±æ‰“æ¶ï¼Ÿ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">position_ids = torch.arange(<span class="hljs-number">512</span>).expand(batch_size, -<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><h3 id="w-h-y">W H Y ?</h3><p>ä¸¤ç§æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-variable language_">self</span>.position_embeddings = nn.Embedding(config.max_position_embeddings, config.hidden_size, padding_idx=<span class="hljs-variable language_">self</span>.padding_idx) <span class="hljs-comment">#æºä»£ç </span><br>position_embeddings = <span class="hljs-variable language_">self</span>.position_embeddings(position_ids)<span class="hljs-comment"># aiå»ºè®®</span><br></code></pre></td></tr></table></figure><table><thead><tr><th>æºä»£ç </th><th>aiå»ºè®®</th></tr></thead><tbody><tr><td>æˆ‘æ²¡æœ‰è¾“å…¥pad_token_idï¼ˆå› ä¸ºç¡®å®ä¸éœ€è¦padï¼‰<br />æ‰€ä»¥å¯¹äºnn.Embeddingæ¥è¯´padding_idxçš„é»˜è®¤å€¼æ˜¯0<br />ç”±æ­¤è¿™ä¸ªå‡½æ•°ç”Ÿæˆçš„position_idsä»1å¼€å§‹ï¼Œ[1,2,3,â€¦â€¦,512]</td><td>ä»0å¼€å§‹ï¼Œ[0,1,2,â€¦â€¦,511]</td></tr></tbody></table><p>aaaaæœç„¶æ˜¯0basedå’Œ1basedä½ ä»¬ä¸¤ä¸ªeeeeeee</p><p>é‚£ä¸ºä»€ä¹ˆ0å¼€å§‹çš„idå¯ä»¥åœ¨æ­¤æˆåŠŸè¿è¡Œè€Œ1å¼€å§‹çš„ä¸è¡Œ</p><h4 id="nn.embeddingä½ åˆåœ¨å¹²å˜›">nn.Embeddingä½ åˆåœ¨å¹²å˜›</h4><p>nn.embeddingæ˜¯pytorchçš„ä¸€ä¸ªåµŒå…¥å±‚ï¼Œä¸»è¦ç”¨äº<strong>å°†ç¦»æ•£çš„ç´¢å¼•ï¼ˆå¦‚å•è¯IDã€ç±»åˆ«IDï¼‰æ˜ å°„åˆ°è¿ç»­çš„é«˜ç»´å‘é‡ç©ºé—´</strong>ã€‚å…¶è¾“å…¥é€šå¸¸æ˜¯ç±»åˆ«å‹æ•°æ®(categoricaldata)ï¼Œæ¯”å¦‚nlpé‡Œçš„tokenidï¼Œæ¨èç³»ç»Ÿé‡Œçš„ç”¨æˆ·idç­‰ç­‰ã€‚é€šä¿—æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¯è®­ç»ƒçš„æŸ¥æ‰¾è¡¨(lookuptable)ï¼Œä½ ç»™å®ƒä¸€ä¸ªæ•´æ•°ç´¢å¼•ï¼Œå®ƒè¿”å›è¿™ä¸ªç´¢å¼•å¯¹åº”çš„åµŒå…¥å‘é‡ã€‚</p><p>é‚£ä¹ˆself.position_embeddingsä¹Ÿå°±ç”Ÿæˆäº†ä¸€ä¸ªè¡¨å¤§å°æœ‰512(max_position_embeddings)ï¼Œç»´åº¦æœ‰256(hidden_size)çš„è¡¨ã€‚è¿™é‡Œçš„è¡¨å¤§å°ä¸æ˜¯word_embeddingé‡Œé¢è¯æ±‡è¡¨çš„å¤§å°ï¼Œè€Œæ˜¯ä¸€æ¡åºåˆ—é•¿åº¦çš„å¤§å°ï¼ˆæŠŠè¯æ±‡è¡¨é‡Œæ¯ä¸ªtokenæ›¿æ¢æˆä¸€æ¡åºåˆ—é‡Œæ¯ä¸ªä½ç½®ï¼‰ã€‚ä¸‹é¢è°ƒç”¨è¿™ä¸ªè¡¨çš„æ—¶å€™ï¼Œè¾“å…¥çš„ç´¢å¼•å°±æ˜¯position_idsã€‚</p><p>embeddingçš„è¡¨ç´¢å¼•ä»0å¼€å§‹ï¼Œæ‰€ä»¥æºä»£ç çš„idæœ€åä¸€ä¸ªç´¢å¼•512åœ¨è¡¨é‡Œå°±æ²¡æœ‰å¯¹åº”çš„åµŒå…¥äº†ï¼Œæ‰€ä»¥å°±indexerroräº†ã€‚</p><h4 id="åˆæ˜¯å•¥æ„æ€">513åˆæ˜¯å•¥æ„æ€</h4><p>ä½†å¦‚æœå¦‚ä¸Šæ‰€è¿°é‚£ä¸ºä»€ä¹ˆè¦æ”¹åˆ°514æ‰æ­£å¸¸â€¦â€¦ï¼Ÿéš¾é“ä¸æ˜¯513å°±åº”è¯¥æ­£å¸¸äº†å—</p><p>å¥³å­©ç»ˆäºç‚¹å¼€äº†è§£å†³é—®é¢˜æœ€åº”è¯¥æ‰“å¼€çš„issueé¡µé¢ï¼Œå¹¶æœç´¢roberta positionidsã€‚ç„¶åå‘ç°robertaæ¨¡å‹ç”±äºä»fairseqé‚£ç»§æ‰¿è¿‡æ¥çš„æ—¶å€™æ²¡æœ‰æ”¹åŠ¨åŸæœ‰çš„æ¨¡å‹é…ç½®ï¼Œå…¶padding_idxçš„é»˜è®¤å€¼å…¶å®æ˜¯ï¼š1ï¼æç„¶å¤§æ‚Ÿçš„å¥³å­©ç»ˆäºå‘ç°äº†å…¶å®åº”è¯¥çœ‹çœ‹RobertaConfigçš„é»˜è®¤å€¼â€¦â€¦</p><p>psï¼šä¸Šé¢æºä»£ç é‡Œå†™çš„é»˜è®¤å€¼å…¶å®æ˜¯æˆ‘æƒ³çŸ¥é“å¦‚æœæˆ‘ä¸è¾“å…¥pad_token_idçš„æ—¶å€™é»˜è®¤å€¼æ˜¯ä»€ä¹ˆï¼Œå¥³å­©ç›´æ¥å»æœnn.embeddingçš„é»˜è®¤å€¼äº†ï¼Œå‹æ ¹æ²¡æœ‰æƒ³åˆ°è¿˜æœ‰ä¸€ä¸ªRobertaConfigâ€¦â€¦é‚£ä¹ˆä¸è¾“å…¥pad_token_idæ—¶ï¼Œæºä»£ç å¾—åˆ°çš„position_idså…¶å®æ˜¯ä»2å¼€å§‹çš„ã€‚ã€‚</p><h3 id="æ‰€ä»¥æ€ä¹ˆè§£å†³ç±»ä¼¼é—®é¢˜">æ‰€ä»¥æ€ä¹ˆè§£å†³ç±»ä¼¼é—®é¢˜</h3><ol type="1"><li>è‡ªå·±è¾“å…¥position_ids</li><li>åœ¨configé‡ŒæŠŠpad_token_idè®¾ç½®ä¸º-1(ä»…å½“ä½ ä¸ç”¨padtokenæ—¶ã€‚å¦‚æœè¦ç”¨ï¼šè‡ªå·±æ„å»ºposition_ids/æ ¹æ®è¯­æ–™é•¿åº¦è°ƒæ•´æœ€é•¿é•¿åº¦)</li></ol><h3 id="å¤ç›˜">å¤ç›˜</h3><p>å°å°é—®é¢˜ç«Ÿæµªè´¹å¥³å­©è¿™ä¹ˆå¤šæ—¶é—´é‚£ä¹ˆä¸ºäº†ä¹‹åæµªè´¹çš„æ—¶é—´å¯ä»¥å°‘ä¸€ç‚¹æˆ‘ä»¬è®¤ä¸ºéœ€è¦å¤ç›˜ä¸€ä¸‹ï¼Œä½†ç°åœ¨ä¸æƒ³å†™ï¼Œä¹‹åæœ‰ç©ºå†æ›´æ–°å§(å¥³å­©ä½ åˆ«ä¸€é¸½å°±æ˜¯æ°¸è¿œ)</p><h4 id="ps-å†è¡¥å……ä¸€ä¸‹position-ids">ps å†è¡¥å……ä¸€ä¸‹position ids</h4><p>é—®äº†ä¸€ä¸‹dsä¸ºä»€ä¹ˆæ ¹æ®inputs_embedsåˆ›å»ºposition_idsæ—¶ï¼ˆå³å‡½æ•°<code>create_position_ids_from_inputs_embeds</code>ï¼‰è¦è€ƒè™‘padding_idxã€‚dså¤§æ€è€ƒä¸€åˆ†å¤šé’Ÿåç­”æ¡ˆæ€»ç»“å¦‚ä¸‹ï¼š</p><blockquote><p>åœ¨Robertaæ¨¡å‹ä¸­ï¼Œåˆ›å»ºä½ç½®IDsæ—¶è€ƒè™‘<code>padding_idx</code>çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†é¿å…ç”Ÿæˆçš„ä½ç½®IDä¸åµŒå…¥å±‚ä¸­çš„å¡«å……ç´¢å¼•å†²çªï¼Œç¡®ä¿ä½ç½®åµŒå…¥çš„æœ‰æ•ˆæ€§ã€‚å…·ä½“åŸå› å¦‚ä¸‹ï¼š</p><ol type="1"><li><strong>é¿å…ä½ç½®åµŒå…¥çš„æ— æ•ˆåŒ–</strong> ï¼šä½ç½®åµŒå…¥å±‚ï¼ˆ<code>Embedding</code>ï¼‰ä¸­çš„<code>padding_idx</code>å¯¹åº”çš„å‘é‡é€šå¸¸è¢«è®¾ç½®ä¸ºé›¶ä¸”ä¸å‚ä¸è®­ç»ƒã€‚è‹¥ä½ç½®IDç­‰äº<code>padding_idx</code>ï¼Œè¯¥ä½ç½®çš„ä½ç½®åµŒå…¥ä¼šè¢«å›ºå®šä¸ºé›¶ï¼Œå¤±å»å­¦ä¹ èƒ½åŠ›ã€‚é€šè¿‡ä»<code>padding_idx + 1</code>å¼€å§‹ç”Ÿæˆä½ç½®IDï¼ˆå¦‚<code>padding_idx=0</code>æ—¶ï¼ŒIDä»1å¼€å§‹ï¼‰ï¼Œæ‰€æœ‰æœ‰æ•ˆä½ç½®å‡è·å¾—éå¡«å……ç´¢å¼•ï¼Œç¡®ä¿ä½ç½®åµŒå…¥è¢«æ­£å¸¸å­¦ä¹ å’Œä½¿ç”¨ã€‚</li><li><strong>å¤„ç†è¾“å…¥çš„ä¸ç¡®å®šæ€§</strong> ï¼š å½“ç›´æ¥æä¾›<code>inputs_embeds</code>æ—¶ï¼Œæ¨¡å‹æ— æ³•åŒºåˆ†å“ªäº›ä½ç½®æ˜¯å¡«å……çš„ï¼ˆå› åµŒå…¥å·²ç”Ÿæˆï¼ŒåŸå§‹è¾“å…¥ä¿¡æ¯ä¸¢å¤±ï¼‰ã€‚æ­¤æ—¶ï¼Œå‡½æ•°<strong>é»˜è®¤æ‰€æœ‰ä½ç½®æœ‰æ•ˆ</strong> ï¼Œç”Ÿæˆè¿ç»­çš„ä½ç½®IDï¼Œå¹¶é€šè¿‡é¿å¼€<code>padding_idx</code>ç¡®ä¿å³ä½¿å­˜åœ¨å¡«å……ï¼Œä½ç½®åµŒå…¥ä¹Ÿä¸ä¼šé”™è¯¯å¼•ç”¨å¡«å……ç´¢å¼•ã€‚</li><li><strong>ä¿æŒä¸€è‡´æ€§</strong> ï¼š åœ¨æ ‡å‡†æµç¨‹ä¸­ï¼Œæ¨¡å‹ä¼šæ ¹æ®<code>input_ids</code>å¤„ç†å¡«å……ä½ç½®ï¼ˆå¦‚å°†å¡«å……tokençš„ä½ç½®IDè®¾ä¸º0ï¼‰ã€‚ä½†å½“æ— æ³•è·å–<code>input_ids</code>æ—¶ï¼Œæ­¤å‡½æ•°é‡‡ç”¨ä¿å®ˆç­–ç•¥ï¼Œç”Ÿæˆä¸ä¸<code>padding_idx</code>å†²çªçš„IDï¼Œä»¥æ¨¡æ‹Ÿéå¡«å……åœºæ™¯ï¼Œé¿å…å¼•å…¥æ„å¤–åå·®ã€‚</li></ol></blockquote><p>æ‰€ä»¥ç¡®å®å’Œinput_idsæ—¶çš„å¤„ç†ç¨æœ‰ä¸åŒï¼Œä¸‹é¢æ˜¯idå¯¹åº”çš„å‡½æ•°<code>create_position_ids_from_input_ids</code>è¯·çœ‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_position_ids_from_input_ids</span>(<span class="hljs-params">input_ids, padding_idx, past_key_values_length=<span class="hljs-number">0</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Replace non-padding symbols with their position numbers. Position numbers begin at padding_idx+1. Padding symbols</span><br><span class="hljs-string">    are ignored. This is modified from fairseq&#x27;s `utils.make_positions`.</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Args:</span><br><span class="hljs-string">        x: torch.Tensor x:</span><br><span class="hljs-string"></span><br><span class="hljs-string">    Returns: torch.Tensor</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># The series of casts and type-conversions here are carefully balanced to both work with ONNX export and XLA.</span><br>    mask = input_ids.ne(padding_idx).<span class="hljs-built_in">int</span>()<br>    incremental_indices = (torch.cumsum(mask, dim=<span class="hljs-number">1</span>).type_as(mask) + past_key_values_length) * mask<br>    <span class="hljs-keyword">return</span> incremental_indices.long() + padding_idx<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆå½“padding_idxè®¾ç½®ä¸º3çš„æ—¶å€™ï¼Œä½ç½®idå°±ä»4å¼€å§‹ã€‚é‚£å‰é¢çš„0ï¼Œ1ï¼Œ2æ€ä¹ˆåŠå‘¢ï¼Ÿdsè¯´ä¸ºäº†é¿å…å’Œå¡«å……ç´¢å¼•å†²çªï¼Œè¿™ä¸‰ä¸ªå°±ä¸ä¼šè¢«ç”¨ä½œä½ç½®idäº†ã€‚</p><p>*ä¸çŸ¥é“å…¶ä»–æ¨¡å‹çš„å®ç°é‡Œæ˜¯å¦æœ‰è¿™äº›é—®é¢˜ï¼Œä½†è¯·æ³¨æ„</p><h2 id="å‚è€ƒå‚è€ƒ">å‚è€ƒå‚è€ƒ</h2><p><ahref="https://github.com/huggingface/transformers/blob/v4.48.2/src/transformers/models/roberta/modeling_roberta.py#L1669">robertaæºä»£ç </a></p><p><ahref="https://github.com/huggingface/transformers/issues/10736#issuecomment-800175342">robertapad tokens</a></p>]]></content>
    
    
    <categories>
      
      <category>note</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>vcf2fasta</title>
    <link href="/2025/01/15/vcf2fasta/"/>
    <url>/2025/01/15/vcf2fasta/</url>
    
    <content type="html"><![CDATA[<h2 id="intro">intro</h2><blockquote><p>å¤ªå¥½äº†ï¼å¥³å­©åªæœ‰åœ¨ddlè¿«è¿‘çš„æ—¶å€™æ‰ä¼šæƒ³èµ·æ¥å†™è¿™äº›ã€</p><p>å…¶å®æœ‰å¾ˆå¤šç¯‡ä½†ä¸çŸ¥ä¸ºä½•æœ‰ç§ä¸€æ¬¡å°±è¦æç¯‡å¤§çš„ä½†å…¶å®çœŸçš„å‘äº†çš„åªæœ‰ä¸€ç¯‡æ¡æ¥çš„</p><p>æ‰€ä»¥åˆåœ¨æ¡ï¼</p></blockquote><h2 id="tldr">TL;DR</h2><p>æ ¹æ®éœ€è¦çš„fastaå†…å®¹é€‰è½¯ä»¶ï¼Œæœ¬æ–‡å…³å¿ƒï¼š</p><ol type="1"><li>ä¸Šä¸‹æ¸¸n bp</li><li>å¤šæ€æ€§ä½ç‚¹æ‰€åœ¨å…ƒä»¶æ•´æ¡åºåˆ—</li></ol><p>ä¸è¡Œçš„è¯æ‰¾å¸ˆå…„å¸ˆå§è€å¸ˆè¦åºåˆ—å§ã€</p><h2 id="è¿™æ˜¯åœ¨å¹²ä»€ä¹ˆ">è¿™æ˜¯åœ¨å¹²ä»€ä¹ˆ</h2><p><strong>æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªå­˜å‚¨äº†ç¾¤ä½“å˜å¼‚ä¿¡æ¯çš„vcfæ–‡ä»¶ï¼Œä½†ç”±äºå„ç§åŸå› å’Œä¸‹æ¸¸åº”ç”¨ï¼Œéœ€è¦å–å‡ºå˜å¼‚ä½ç‚¹ä¸¤ä¾§çš„åºåˆ—ã€‚</strong></p><p>ä½œä¸ºå­˜å‚¨å˜å¼‚ä¿¡æ¯çš„æ–‡ä»¶æ ¼å¼ï¼Œvcfæ–‡ä»¶ä¿å­˜çš„ä¿¡æ¯å¯ä»¥è¯´æ˜¯ä½ç‚¹ä¿¡æ¯ã€‚ä»ä½ç‚¹ä¿¡æ¯åˆ°åºåˆ—ä¿¡æ¯ï¼Œéœ€è¦åšåˆ°çš„å°±æ˜¯åœ¨æ£€æµ‹å˜å¼‚æ—¶æ‰€ç”¨åˆ°çš„å‚è€ƒåŸºå› ç»„é‡Œå®šä½åˆ°ç›¸åº”ä½ç‚¹ï¼Œå†æŒ‰ç…§åç»­å¯¹è¿™ä¸ªåºåˆ—çš„æ“ä½œç›®çš„æ¥å–åŒ…å«è¿™ä¸ªä½ç‚¹çš„ä¸Šä¸‹æ¸¸åºåˆ—(æ„æ€æ˜¯ä½ æ˜¯æƒ³å–è¿™ä¸ªå¤šæ€æ€§ä½ç‚¹æ‰€åœ¨çš„åŸºå› /CDSæˆ–è€…ä»€ä¹ˆç‰¹å®šçš„ç‰‡æ®µï¼Œè¿˜æ˜¯ä½ åªæ˜¯å…³å¿ƒè¿™ä¸ªä½ç‚¹çš„é‚»å±…ä»¬éƒ½æ˜¯äº›ä»€ä¹ˆè´§è‰²)ã€‚å¾ˆç®€å•çš„æ€è·¯ï¼ä¸å¤ªç¡®å®šè‡ªå·±å†™çš„å·¥ä½œé‡æœ‰å¤šå°‘ï¼Œä½†æ—¢ç„¶åˆ«äººéƒ½å†™è¿‡äº†ä¸ºä»€ä¹ˆä¸æ‹¿ã€ä»€ä¹ˆéƒ½å†™åªä¼šè®©ä½ æˆä¸ºä¸€ä¸ªå¾ˆå‰å®³çš„å†™ä»£ç çš„æˆ‘å¸Œæœ›æŠ±å¤§è…¿çš„äººï¼</p><h2 id="æ€ä¹ˆåš">æ€ä¹ˆåš</h2><h3 id="jvarkit----java-utilities-for-bioinformatics">jvarkit -- Javautilities for Bioinformatics</h3><p>åœ¨BioStaré‡Œç»æœ›æŸ¥æ‰¾æ—¶æ‰¾åˆ°çš„å’Œå½“æ—¶æˆ‘çš„éœ€æ±‚æœ€åŒ¹é…çš„ä¸€ä¸ªåŒ…ï¼Œå‘µå‘µè™½ç„¶ä¹‹åè¿˜æ˜¯åˆæ”¹äº†æ–¹å‘ä¸å†ä½¿ç”¨ä½†è¿˜æ˜¯çŒ®ä¸Šæˆ‘çš„æ„Ÿæ¿€ä¹‹æƒ…ï¼æ­¤åŒ…åŸºäºjavaå¼€å‘ï¼Œæœ‰è¶…å¤šåŠŸèƒ½ç®€å•æ€»ç»“è¿™ä¸ªåŒ…æ€ä¹ˆç”¨ï¼š</p><ol type="1"><li><p>å…ˆæŠŠå‚è€ƒåŸºå› ç»„æ–‡ä»¶æ‹¿åˆ°ï¼</p></li><li><p>jvarkité‡Œçš„biostar251649jaråŒ…ä¼šåœ¨åŸvcfæ–‡ä»¶çš„åŸºç¡€ä¸Šï¼Œåœ¨vcfçš„æ•°æ®éƒ¨åˆ†é‡Œçš„INFOéƒ¨åˆ†åŠ ä¸Šä¸¤ä¸ªå­—æ®µï¼šSEQ3_30å’ŒSEQ5_30(30æ˜¯ä¸Šä¸‹æ¸¸åºåˆ—çš„é•¿åº¦ï¼Œå¯æ”¹)ï¼Œè¾“å‡ºç›¸åº”çš„æ–°vcfæ–‡ä»¶ã€‚</p></li><li><p>jvarkité‡Œçš„bioalcidaejdk*jaråŒ…å¯ä»¥æŠŠè¿™ä¸ªæ–°vcfæ–‡ä»¶é‡Œçš„ä¸¤ä¸ªæ–°å­—æ®µæå–å‡ºæ¥ï¼Œå’Œå˜å¼‚ä¿¡æ¯ç»„æˆåºåˆ—</p><p>*ä½ ä»¥ä¸ºè¿™æ˜¯è„¸æ»šé”®ç›˜å…¶å®æ­¤åŒ…æ˜¯java-based version of awk ofbioinformaticsï¼Œbioå’Œjdkå¥½ç†è§£ï¼ŒAlcidae(æµ·é›€ç§‘)ï¼Ÿå› ä¸ºæµ·é›€çš„è‹±æ–‡æ˜¯aukâ€¦just sooo random! å¼•ç”¨æ¥è‡ªæ–‡æ¡£(å¥³å­©ä½ è¿˜ä¸“é—¨å»çœ‹äº†â€¦ï¼Ÿ)</p></li></ol><blockquote><p><strong>Why this name</strong></p><p>As 'bioalcidae' looks like an 'awk' for bioinformatics, we used '<ahref="https://en.wikipedia.org/wiki/Alcidae">Alcidae</a>', the taxonomicFamily of the '<a href="https://en.wikipedia.org/wiki/Auk">auk</a>'species.</p></blockquote><p>æ ¹æ®å®é™…è°ƒè¯•å‘ç°ï¼šæ­¤åŒ…å¯¹å˜å¼‚æ˜¯SNPè¿˜æ˜¯Indelï¼Œæ˜¯åŒç­‰ä½è¿˜æ˜¯å¤šç­‰ä½éƒ½ä¸æ•æ„Ÿï¼ˆä¸‹é¢ä¾‹å­å¯å¾—ï¼‰ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">## å¾—åˆ°çš„æ–°vcf</span><br>$ java -jar dist/biostar251649.jar -n 10 -R tests/ref.fa tests/mutations.vcf<br><span class="hljs-comment">##INFO=&lt;ID=SEQ3_10,Number=1,Type=String,Description=&quot;Sequence on the 3&#x27; of mutation&quot;&gt;</span><br><span class="hljs-comment">##INFO=&lt;ID=SEQ5_10,Number=1,Type=String,Description=&quot;Sequence on the 5&#x27; of mutation&quot;&gt;</span><br>(...)<br><span class="hljs-comment">#CHROM  POS ID  REF ALT QUAL    FILTER  INFO    FORMAT  S1  S2  S3  S4</span><br>rotavirus   51  .   A   G   22.55   .   AC1=2;AF1=0.25;BQB=1;DP=944;DP4=849,0,93,0;FQ=23.7972;G3=0.75,0,0.25;HWE=0.033921;MQ=60;MQ0F=0;MQB=1;PV4=1,1,1,1;RPB=0.993129;SEQ3_10=GATGGTAAGC;SEQ5_10=TCTACTCAGC;SGB=-61.9012;VDB=3.53678e-05    GT:PL   0/0:0,255,134   0/0:0,255,127   0/0:0,255,137   1/1:70,255,0<br>rotavirus   91  .   A   T   5.45    .   AC1=1;AF1=0.124963;BQB=0.951201;DP=1359;DP4=1134,0,225,0;FQ=5.8713;MQ=60;MQ0F=0;MQB=1;PV4=1,4.80825e-05,1,1;RPB=0.0393173;SEQ3_10=GTTGTTGCTG;SEQ5_10=TTGAAGCTGC;SGB=-369.163;VDB=0.313337   GT:PL   0/0:0,255,133   0/1:40,0,31 0/0:0,255,134   0/0:0,255,82<br><br><span class="hljs-comment">## å–åºåˆ—</span><br>java -jar dist/bioalcidaejdk.jar -F VCF -e <span class="hljs-string">&#x27;stream().forEach(V-&gt;println(&quot;&gt;&quot;+V.getContig()+&quot;:&quot;+V.getStart()+&quot;\n&quot;+V.getAttribute(&quot;SEQ5_20&quot;)+&quot;[&quot;+V.getAlleles().stream().map(A-&gt;A.getDisplayString()).collect(Collectors.joining(&quot;/&quot;))+&quot;]&quot;+V.getAttribute(&quot;SEQ3_20&quot;)));&#x27;</span><br><br>&gt;rotavirus:51<br>TGGTCGATTGCTCTATTGAA[A/G]AATTTCCATTGATGGCTAAA <br><span class="hljs-comment"># è¿™é‡Œä¼šæŠŠåŒ…æ‹¬å‚è€ƒåŸºå› å‹å’Œå˜å¼‚åŸºå› å‹éƒ½åˆ—åœ¨[]é‡Œï¼Œæ‰€ä»¥è¯´å¯¹snp/indelï¼ŒåŒ/å¤šç­‰ä½ä¸ä¼šå¾ˆæ•æ„Ÿ</span><br></code></pre></td></tr></table></figure><p>è¯¦è§£ç¬¬äºŒæ­¥ä»£ç çš„-e(æ¥è‡ªä½œè€…åœ¨biostars 334253é‡Œçš„å›ç­”)</p><blockquote><p><code>stream()</code> convert to a stream of variant</p><p><code>forEach(V-&gt;println("&gt;"</code> for each variant startwriting the fasta header</p><p><code>V.getContig()+":"+V.getStart()+"\n"</code> write the fastaheader</p><p><code>V.getAttribute("SEQ5_20")</code> write 5' seq</p><p><code>["+V.getAlleles().stream().map(A-&gt;A.getDisplayString()).collect(Collectors.joining("/"))+"]"</code>write all alleles separated with '/'</p><p><code>V.getAttribute("SEQ3_20")))</code> write 3' seq</p></blockquote><p>æˆ‘è‡ªå·±æ‰¹é‡å¤„ç†vcfçš„ä¸€æ®µä»£ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs bash">/#!/bin/bash<br><span class="hljs-comment">#SBATCH --job-name=          # ä½œä¸šåç§°</span><br><span class="hljs-comment">#SBATCH --output=        # æ ‡å‡†è¾“å‡ºæ–‡ä»¶</span><br><span class="hljs-comment">#SBATCH --error=         # æ ‡å‡†é”™è¯¯æ–‡ä»¶</span><br><span class="hljs-comment">#SBATCH --time=                     # è¿è¡Œæ—¶é—´ï¼ˆæ ¼å¼ï¼šHH:MM:SSï¼‰</span><br><span class="hljs-comment">#SBATCH --ntasks=1                          # åˆ†é…ä»»åŠ¡æ•°</span><br><span class="hljs-comment">#SBATCH --cpus-per-task=4                   # æ¯ä¸ªä»»åŠ¡åˆ†é…çš„CPUæ•°é‡ï¼ˆæ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰</span><br><span class="hljs-comment">#SBATCH --mem=16G                           # åˆ†é…å†…å­˜ï¼ˆæ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰</span><br><br><br><span class="hljs-comment"># è®¾ç½®è„šæœ¬åœ¨é‡åˆ°é”™è¯¯æ—¶åœæ­¢</span><br><span class="hljs-built_in">set</span> -e<br><br><span class="hljs-comment"># æ ·å“æ–‡ä»¶è·¯å¾„</span><br>SAMPLE_FILE=<span class="hljs-string">&quot;/path/to/sample/file&quot;</span><br><br><span class="hljs-comment"># VCF è¾“å…¥æ–‡ä»¶è·¯å¾„</span><br>VCF_INPUT=<span class="hljs-string">&quot;/path/to/vcf&quot;</span><br><br><span class="hljs-comment"># åŸºå› ç»„å‚è€ƒåºåˆ—è·¯å¾„</span><br>REFERENCE_GENOME=<span class="hljs-string">&quot;/path/to/fna&quot;</span><br><br><span class="hljs-comment"># JVarkit å·¥å…·è·¯å¾„</span><br>JVARKIT_JAR=<span class="hljs-string">&quot;/path/to/jvarkit.jar&quot;</span><br><br><span class="hljs-comment"># è¾“å‡ºç›®å½•ï¼ˆå¯é€‰ï¼Œå»ºè®®ç»Ÿä¸€è¾“å‡ºåˆ°ä¸€ä¸ªç›®å½•ï¼‰</span><br>OUTPUT_DIR=<span class="hljs-string">&quot;/path/to/output/dir&quot;</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$OUTPUT_DIR</span>&quot;</span><br><br><span class="hljs-comment"># è¯»å–æ¯ä¸ªæ ·å“å¹¶å¤„ç†</span><br><span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r SAMPLE || [[ -n <span class="hljs-string">&quot;<span class="hljs-variable">$SAMPLE</span>&quot;</span> ]]; <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;å¼€å§‹å¤„ç†æ ·å“: <span class="hljs-variable">$SAMPLE</span>&quot;</span><br><br>    <span class="hljs-comment"># æ­¥éª¤ 1: ä½¿ç”¨ bcftools æå–æ ·å“ VCF</span><br>    bcftools view -Ov -s <span class="hljs-string">&quot;<span class="hljs-variable">$SAMPLE</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$VCF_INPUT</span>&quot;</span> -o <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>.vcf&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ç”Ÿæˆ <span class="hljs-variable">$&#123;SAMPLE&#125;</span>.vcf&quot;</span><br><br>    <span class="hljs-comment"># æ­¥éª¤ 2: ä½¿ç”¨ GATK é€‰æ‹©å˜å¼‚ (ä¸»è¦æ˜¯æƒ³å–æ¯ä¸ªæ ·å“çš„å˜å¼‚)</span><br>    gatk SelectVariants -V <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>.vcf&quot;</span> --exclude-non-variants -O <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>_variant.vcf&quot;</span><br>    <span class="hljs-comment">#echo &quot;ç”Ÿæˆ $&#123;SAMPLE&#125;_variant.vcf&quot;</span><br><br>    <span class="hljs-comment"># æ­¥éª¤ 3: ä½¿ç”¨ JVarkit æå– flanking regions</span><br>    java -jar <span class="hljs-string">&quot;<span class="hljs-variable">$JVARKIT_JAR</span>&quot;</span> biostar251649 \<br>        -R <span class="hljs-string">&quot;<span class="hljs-variable">$REFERENCE_GENOME</span>&quot;</span> \<br>        <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>.vcf&quot;</span> -n 50 &gt; <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>_flank.vcf&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ç”Ÿæˆ <span class="hljs-variable">$&#123;SAMPLE&#125;</span>_flank.vcf&quot;</span><br><br>    <span class="hljs-comment"># æ­¥éª¤ 4: ä½¿ç”¨ JVarkit ç”Ÿæˆ FASTA æ–‡ä»¶</span><br>    <span class="hljs-comment"># å¦‚æœæ”¹äº†ä¸Šä¸‹æ¸¸é•¿åº¦ï¼Œè¿™é‡Œä¹Ÿè®°å¾—æ”¹</span><br>    java -jar <span class="hljs-string">&quot;<span class="hljs-variable">$JVARKIT_JAR</span>&quot;</span> bioalcidaejdk \<br>        -F VCF -e <span class="hljs-string">&#x27;stream().forEach(V-&gt;println(&quot;&gt;&quot;+V.getContig()+&quot;:&quot;+V.getStart()+&quot;\n&quot;+V.getAttribute(&quot;SEQ5_50&quot;)+&quot;[&quot;+V.getAlleles().stream().map(A-&gt;A.getDisplayString()).collect(Collectors.joining(&quot;/&quot;))+&quot;]&quot;+V.getAttribute(&quot;SEQ3_50&quot;)));&#x27;</span> \<br>        <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>_flank.vcf&quot;</span> &gt; <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="hljs-variable">$&#123;SAMPLE&#125;</span>_flank.fasta&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;ç”Ÿæˆ <span class="hljs-variable">$&#123;SAMPLE&#125;</span>_flank.fasta&quot;</span><br><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;å®Œæˆå¤„ç†æ ·å“: <span class="hljs-variable">$SAMPLE</span>&quot;</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;-----------------------------------------&quot;</span><br><br><span class="hljs-keyword">done</span> &lt; <span class="hljs-string">&quot;<span class="hljs-variable">$SAMPLE_FILE</span>&quot;</span><br><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;æ‰€æœ‰æ ·å“å¤„ç†å®Œæˆï¼&quot;</span><br></code></pre></td></tr></table></figure><h3 id="vcf2fasta">vcf2fasta</h3><p>æˆ‘çŒœè¿™ä¸ªåº”è¯¥æ˜¯ä¹‹å‰ç”¨å¾—æ¯”è¾ƒå¤šçš„ä¸€ä¸ªâ€¦â€¦ï¼Ÿä½†ä¸çŸ¥é“ä¹‹å‰å¤§å®¶ç”¨æ¥å¹²ä»€ä¹ˆã€‚å’Œä¸Šé¢çš„åŒ…çš„ä¸»è¦åŒºåˆ«æ˜¯è¿™ä¸ªåŒ…ä¼šæ ¹æ®gffæ–‡ä»¶é‡Œé¢çš„åŸºå› ç»„ç‰¹å¾æå–åºåˆ—ï¼Œæ‰€ä»¥è¿™ä¸ªåŒ…çš„åºåˆ—æå–æ˜¯ä»¥åŸºå› ç»„ç‰¹å¾ä¸ºä¸»çš„ï¼Œå’Œä¸Šé¢ä»¥å¤šæ€æ€§ä½ç‚¹ä¸ºä¸»ä¸åŒã€‚</p><p>ç¿»æ‰¾è‡ªå·±çš„æ–‡ä»¶å‘ç°æ—©å°±æŠŠä½¿ç”¨æ­¤åŒ…çš„ä»£ç åˆ æ‰äº†ï¼Œå› ä¸ºå½“æ—¶ç”¨äº†ä¹‹åç»“æœâ€¦â€¦ã€å‰æƒ…æè¦ï¼šå½“æ—¶çš„éœ€æ±‚æ˜¯å–æ‰€æœ‰æ ·å“æŸä¸ªåŸºå› çš„åºåˆ—ï¼Œåœ¨æœ‰æµ‹åºæ•°æ®çš„å‰æä¸‹å…¶å®å¯ä»¥ç”¨ç»„è£…æ•°æ®æ¥åšä½†æˆ‘æ²¡æœ‰ï¼æ‰€ä»¥å°±å…ˆè¯•ç€æ ¹æ®æœ‰çš„ç¾¤ä½“vcfæ–‡ä»¶å’Œå‚è€ƒåºåˆ—æ¥å–äº†ã€‘ä¸èƒ½è¯´æ˜¯é”™å§ï¼Œå¯èƒ½å’Œç”¨çš„gffæ–‡ä»¶é‡Œé¢æ³¨é‡Šæœ‰å…³ç³»ï¼Œå–å‡ºæ¥çš„è›‹ç™½è´¨ç¼–ç åŸºå› ä¸æ˜¯èµ·å§‹å¯†ç å­å¼€å¤´ï¼Œå½±å“äº†åç»­çš„è®¡ç®—ï¼å›é¦–è¿‡å¾€è§‰å¾—å¦‚æœè¦è§£å†³çš„è¯åº”è¯¥æ˜¯å›å¤´ç¡®è®¤gffæ–‡ä»¶å¯¹ç›®æ ‡åŸºå› çš„æ³¨é‡Šåˆ°åº•æ˜¯ä»å“ªå¼€å§‹ï¼Œå¯¹åº”çš„å…·ä½“åºåˆ—åˆæ˜¯ä»€ä¹ˆã€‚è™½ç„¶è½¯ä»¶å¯¹CDSçš„inframeæ˜¯æœ‰å‚æ•°è®¾å®šçš„ï¼Œä½†æˆ‘éœ€è¦æ•´ä¸ªåŸºå› ï¼å½“æ—¶å› ä¸ºå¤ªèµ¶äº†æœ€åé€šè¿‡æœ€ç®€å•ä¹Ÿæ˜¯æœ€éš¾çš„ã€é—®å¸ˆå…„è¦ç»„è£…å¥½çš„åºåˆ—ã€‘è§£å†³äº†å‘µå‘µã€‚æ‰€ä»¥åç»­å¦‚æœè¿˜éœ€è¦ä½¿ç”¨è¯·æ³¨æ„ã€‚</p><p>æ€ä¹ˆç”¨ï¼š</p><ol type="1"><li><p>å‡†å¤‡å‚è€ƒåºåˆ—ï¼Œéœ€è¦å‚è€ƒåŸºå› ç»„çš„faæ–‡ä»¶å’Œgffæ–‡ä»¶ã€‚å‚è€ƒåŸºå› ç»„çš„faæ–‡ä»¶éœ€è¦ç”¨samtoolsè¿›è¡Œindexï¼›å¦‚æœä½ çš„gffæ–‡ä»¶éå¸¸æœ‰ä¸ªäººç‰¹è‰²çš„è¯ï¼Œå»githubçœ‹çœ‹ç¬¦ä¸ç¬¦åˆè½¯ä»¶çš„è¦æ±‚ã€‚vcfæ–‡ä»¶ä¹Ÿè¦indexï¼Œä½†ç”¨tabixã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">samtools faidx ref.fa<br>bgzip my_vcf_file.vcf<br>tabix my_vcf_file.vcf.gz<br></code></pre></td></tr></table></figure></li><li><p>ä¸‹è½½æœ¬ä½“ã€pysamå’ŒartåŒ…</p></li><li><p>æœ€ç®€å•çš„ç”¨æ³•ï¼Œå…¶ä»–å‚æ•°æŒ‰-hæˆ–è€…çœ‹githubå§ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python vcf2fasta.py -f genome.fas -v variants.vcf.gz -g intervals.gff -e CDS<br></code></pre></td></tr></table></figure></li><li><p>è®¾å®šäº†-e CDSä¹‹åä¼šè¾“å‡ºæ‰€æœ‰çš„CDSï¼Œï¼Œå¸Œæœ›ä¹‹åèƒ½æœ‰ç”¨</p></li></ol><h2 id="ä¸Šé¢çš„é“¾æ¥">ä¸Šé¢çš„é“¾æ¥ğŸ”—</h2><p><a href="https://github.com/lindenb/jvarkit">jvarkit_github</a></p><p><ahref="https://jvarkit.readthedocs.io/en/latest/">jvarkit_document</a></p><p><ahref="https://github.com/santiagosnchez/vcf2fasta">vcf2fasta</a></p><p>BioStarsçš„å¸–å­</p><p><a href="https://www.biostars.org/p/251649/">251649</a></p><p><a href="https://www.biostars.org/p/334253/">334253</a></p><h2 id="ç»“æŸ">ç»“æŸã€</h2><p>æ­¤åœ°çš„ä¸€ä¸ªå¥½å¤„æ˜¯å†™æ­£ç»ç¬”è®°çš„åŒæ—¶å¥³å­©è¿˜æ˜¯ä¸ç”±è‡ªä¸»æ•£å‘å‡ºä¸€ç§absent-mindedçš„è¯­è¨€é£æ ¼ï¼Œä½†å¦‚æœä½ çš„åå­—ä¸æ˜¯æ²¡æœ‰äººçš„è¯ä½ ä¸ä¼šåœ¨æ„ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>note</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>ä¸ºä»€ä¹ˆpythonè¾“å‡ºåœ¨outæ–‡ä»¶é‡Œä¸æ˜¾ç¤ºå•Šï¼ï¼</title>
    <link href="/2024/12/10/flush_slurm/"/>
    <url>/2024/12/10/flush_slurm/</url>
    
    <content type="html"><![CDATA[<h2 id="æ­¤ç«Ÿç„¶ä¸ºç¬¬ä¸€ç¯‡">æ­¤ç«Ÿç„¶ä¸ºç¬¬ä¸€ç¯‡ã€</h2><blockquote><p>å…¶å®æ–­æ–­ç»­ç»­æœ‰äº”ç¯‡è‰ç¨¿ä½†æœ€åè¿˜æ˜¯å…ˆæŠŠæ¡æ¥çš„ä¸œè¥¿å‘äº†ã€ã€ã€</p></blockquote><p>ä¸ºä»€ä¹ˆæŠ•å®Œä»»åŠ¡ä¹‹åæˆ‘çš„è¿›åº¦è¾“å‡ºä¸æ˜¾ç¤ºåœ¨outæ–‡ä»¶é‡Œå•Šï¼ï¼â€”â€”æ¥è‡ªï¼šè¦å¤„ç†å¤šä¸ªæ ·å“æœ¬æ¥ä»¥ä¸ºä¸€æ™šä¸Šè‚¯å®šç»“æŸæ—©ä¸Šä¸Šå·¥è¾“å…¥squeueåå‘ç°ä»é¥é¥æ— æœŸç»ˆäºåœ¨18ä¸ªå°æ—¶åè®¤ä¸ºç­‰å¾…æ˜¯é«˜é£é™©ã€ä¸»è¦è¿˜æ˜¯è€å¸ˆé™ä¸´è§†å¯Ÿåæ„Ÿåˆ°å¤§ç¥¸ä¸´å¤´ã€‘äºæ˜¯åŠ äº†ä¸¤æ¡è¾“å‡ºæ„å›¾ç›‘æ§è¿›åº¦ä½†å‘ç°1å°æ—¶è¿‡å»outæ–‡ä»¶å¹²å‡€å¾—å¦‚åŒè„‘å­çš„ä¸€ä½</p><p>è¢«å…‰ç›˜å¤´ç³Šå¼„ä¸¤ä¸ªæ¥å›åå‘ç°å’•ç‹—ç»™æˆ‘çš„ç­”æ¡ˆæ‰æ˜¯æ­£ç¡®çš„ï¼Œå®è·µåç—›æ–¥å…‰ç›˜å¤´å¾—åˆ°ä»¥ä¸‹æ€»ç»“ï¼Œä¹‹åè¯·ç•™æ„ï¼š</p><h2 id="tldr">TL;DR</h2><p>ç”¨python -u urscript.py</p><h2 id="æ˜¯ç¼“å†²åŒº">æ˜¯ç¼“å†²åŒºï¼</h2><p>Python çš„ <code>print()</code>å‡½æ•°å°†å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆé€šå¸¸æ˜¯ç»ˆç«¯æˆ–æ–‡ä»¶ï¼‰ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯ç«‹å³å°†å†…å®¹å†™å…¥å±å¹•æˆ–æ–‡ä»¶ä¸­ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼ŒPythonä¼šå°†è¾“å‡ºå†…å®¹ç¼“å­˜èµ·æ¥ï¼Œç„¶ååœ¨é€‚å½“çš„æ—¶å€™ï¼ˆå¦‚ç¼“å†²åŒºæ»¡æ—¶ï¼‰æ‰å°†è¿™äº›å†…å®¹ä¸€æ¬¡æ€§åœ°è¾“å‡ºã€‚</p><blockquote><p>è¾“å‡ºç¼“å†²åŒºçš„ä¸‰ç§æ–¹å¼ï¼š</p><ol type="1"><li><strong>è¡Œç¼“å†²</strong> ï¼šå½“è¾“å‡ºä¸­åŒ…å«æ¢è¡Œç¬¦ï¼ˆä¾‹å¦‚<code>print("Hello")</code>ï¼‰æ—¶ï¼ŒPythonä¼šè‡ªåŠ¨åˆ·æ–°ç¼“å†²åŒºå¹¶è¾“å‡ºå†…å®¹ã€‚é€šå¸¸åœ¨äº¤äº’å¼ç¯å¢ƒï¼ˆå¦‚ç»ˆç«¯ï¼‰ä¸­ï¼Œ<code>print()</code>ä¼šåŠæ—¶æ˜¾ç¤ºã€‚</li><li><strong>å…¨ç¼“å†²</strong> ï¼šå¯¹äºæ–‡ä»¶å’Œé‡å®šå‘åˆ°æ–‡ä»¶çš„æ ‡å‡†è¾“å‡ºï¼ŒPythoné»˜è®¤ä¼šä½¿ç”¨å…¨ç¼“å†²æ¨¡å¼ï¼Œå³å½“ç¼“å†²åŒºæ»¡æ—¶æ‰ä¼šå†™å…¥æ–‡ä»¶ã€‚è¿™æ„å‘³ç€å¦‚æœä½ åœ¨æ–‡ä»¶ä¸­è¾“å‡ºï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡æˆ–è€…ç¨‹åºç»“æŸï¼Œæ‰ä¼šå°†å†…å®¹å†™å…¥æ–‡ä»¶ã€‚</li><li><strong>æ— ç¼“å†²</strong> ï¼šæ— ç¼“å†²æ¨¡å¼ä¸‹ï¼Œ<code>print()</code>å‡½æ•°ä¼šç«‹å³å°†è¾“å‡ºå†…å®¹å†™å…¥æ–‡ä»¶æˆ–æ˜¾ç¤ºåˆ°ç»ˆç«¯ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½® Pythonçš„è¾“å‡ºæµä¸ºæ— ç¼“å†²æ¥é¿å…ç¼“å†²çš„é—®é¢˜ã€‚</li></ol></blockquote><h2 id="ç¼“å†²åŒºä¸ºä»€ä¹ˆå¯¼è‡´æ­¤é—®é¢˜">ç¼“å†²åŒºä¸ºä»€ä¹ˆå¯¼è‡´æ­¤é—®é¢˜</h2><p>åœ¨æäº¤ä½œä¸šæ—¶ï¼ˆæ¯”å¦‚ä½¿ç”¨ <code>sbatch</code>ï¼‰ï¼ŒSlurmä¼šå°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶ä¸­ã€‚å¦‚æœ Pythonä½¿ç”¨äº†ç¼“å†²è¾“å‡ºï¼Œè€Œè„šæœ¬æ²¡æœ‰ç»“æŸæˆ–è€…æ²¡æœ‰å†™å…¥æ¢è¡Œç¬¦ï¼Œç¼“å†²åŒºçš„å†…å®¹å¯èƒ½ä¸ä¼šè¢«åŠæ—¶å†™å…¥è¾“å‡ºæ–‡ä»¶ã€‚è¿™æ ·ï¼Œä½ å°±æ— æ³•åœ¨æ—¥å¿—æ–‡ä»¶ä¸­çœ‹åˆ°<code>print</code> è¾“å‡ºã€‚</p><h2id="è§£å†³åŠæ³•è™½ç„¶éƒ½æ˜¯ä¸€å›äº‹ä½†ä»ç„¶æ‘†å‡ºä¸‰æ¡like-whyå› ä¸ºæ˜¯ç¬”è®°">è§£å†³åŠæ³•ï¼ˆè™½ç„¶éƒ½æ˜¯ä¸€å›äº‹ä½†ä»ç„¶æ‘†å‡ºä¸‰æ¡ï¼Œlikewhyï¼ˆå› ä¸ºæ˜¯ç¬”è®°</h2><ol type="1"><li>æ˜¾å¼åˆ·æ–°ç¼“å†²åŒºï¼š å¯ä»¥é€šè¿‡åœ¨ <code>print()</code> è¯­å¥åé¢æ·»åŠ flush=True æ¥å¼ºåˆ¶ Python åœ¨æ¯æ¬¡è¾“å‡ºæ—¶åˆ·æ–°ç¼“å†²åŒºã€‚ä¾‹å¦‚ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;sample_name&#125;</span> processed&quot;</span>, flush=<span class="hljs-literal">True</span>)<br></code></pre></td></tr></table></figure><p>è¿™æ ·ç¡®ä¿æ¯æ¬¡<code>print()</code>è¾“å‡ºéƒ½ä¼šåˆ·æ–°ç¼“å†²åŒºï¼Œä»è€Œè¾“å‡ºåˆ°outæ–‡ä»¶é‡Œ</p><ol start="2" type="1"><li>ç”¨ sys.stdout.flush()ï¼š ä¹Ÿå¯ä»¥æ˜¾å¼åœ°ä½¿ç”¨<code>sys.stdout.flush()</code>æ¥åˆ·æ–°ç¼“å†²åŒºã€‚è¿™å¯ä»¥åœ¨è„šæœ¬çš„ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä»¥ç¡®ä¿è¾“å‡ºè¢«åŠæ—¶åˆ·æ–°åˆ°æ ‡å‡†è¾“å‡ºã€‚ä¾‹å¦‚ï¼š</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;sample_name&#125;</span> processed&quot;</span>)<br>sys.stdout.flush()  <span class="hljs-comment"># å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒº</span><br></code></pre></td></tr></table></figure><ol start="3" type="1"><li>ç¦ç”¨ç¼“å†²ï¼šå¦‚æœè¦åœ¨æ‰€æœ‰è¾“å‡ºä¸­éƒ½ç¦ç”¨ç¼“å†²ï¼Œåˆ™å¯ä»¥ç›´æ¥åœ¨è¿è¡Œè„šæœ¬æ—¶ä½¿ç”¨-uå‚æ•°ï¼Œè®©pythonä»¥æ— ç¼“å†²æ¨¡å¼è¿è¡Œ</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">python -u my_script.py<br></code></pre></td></tr></table></figure><ol start="4" type="1"><li>ä½¿ç”¨æ—¥å¿—æ¨¡å—ï¼š<em>(æ€ä¹ˆå›äº‹ä¸æ˜¯åªæœ‰ä¸‰æ¡å—ï¼)(å› ä¸ºå’Œä¸Šé¢ä¸‰ä¸ªä¸ä¸€æ ·)</em>å¯ä»¥è€ƒè™‘ç”¨pythonçš„<code>logging</code>æ¨¡å—<em>(æ²¡ç”¨è¿‡)</em>ï¼Œæ­¤æ¨¡å—å…è®¸ä½ è®°å½•è°ƒè¯•ã€ä¿¡æ¯ã€è­¦å‘Šã€é”™è¯¯å’Œè‡´å‘½é”™è¯¯<em>(wow)</em>ç­‰ä¸åŒçº§åˆ«æ—¥å¿—ï¼Œå¯ä»¥é…ç½®å…¶ä½¿å¾—è¾“å‡ºç«‹å³å†™å…¥æ–‡ä»¶/å®šæœŸåˆ·æ–°</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> logging<br><br>logging.basicConfig(level=logging.DEBUG, <span class="hljs-built_in">format</span>=<span class="hljs-string">&#x27;%(asctime)s - %(message)s&#x27;</span>, handlers=[logging.StreamHandler(), logging.FileHandler(<span class="hljs-string">&#x27;job_output.log&#x27;</span>)])<br>logging.debug(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;sample_name&#125;</span> processed&quot;</span>)<br><span class="hljs-comment"># è°çœ‹æ‡‚äº†ã€</span><br></code></pre></td></tr></table></figure><h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ğŸ”—</h2><p><ahref="https://blog.csdn.net/MissShihong/article/details/107862293">åŒç—…ç›¸æ€œæ–‡</a></p><p>&amp;å…‰ç›˜å¤´è€å¸ˆ</p><h2 id="ç»“æŸ-é€€æœ">ç»“æŸ é€€æœ</h2>]]></content>
    
    
    <categories>
      
      <category>note</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>hello world</title>
    <link href="/2024/10/05/hello-world/"/>
    <url>/2024/10/05/hello-world/</url>
    
    <content type="html"><![CDATA[<h3 id="mood">mood:</h3><p><em>é™·å…¥ä¸€ç§å°æ—¶å€™æ‹¿åˆ°ä¸€ä¸ªæ¼‚äº®æœ¬å­å´ä¸€æ—¶ä¸çŸ¥é“è¦åœ¨ä¸Šé¢å†™ä»€ä¹ˆçš„æœŸå¾…å’Œè¸Œèº‡æ„Ÿã€‚</em></p><blockquote><p>sorry but æœ¬äººçš„æ‰€æœ‰å¼€å¤´å¤§éƒ½å¦‚æ­¤æ½¦è‰</p></blockquote><p>äººä¸ºç»™è‡ªå·±åˆ›é€ äº†ä¸€ä¸ªæ–°éœ€æ±‚ï¼Œéšä¾¿æ”¾ç‚¹ã€‚</p><p>ä¸»è¦æ˜¯ä¸€äº›ç¬”è®°ã€hopesoã€‘ï¼Œè¿™ä½å°å§æœ€å¥½ä¸è¦æŠŠè¿™é‡Œä¹Ÿææˆè‡ªå·±çš„egoå’Œåæƒ…ç»ªéšæ„å‘å°„åœ°ã€ã€</p>]]></content>
    
    
    <categories>
      
      <category>random</category>
      
    </categories>
    
    
  </entry>
  
  
  
  
</search>
